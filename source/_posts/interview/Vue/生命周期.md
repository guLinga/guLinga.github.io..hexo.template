---
title: Vue生命周期
date: 2022-11-12
categories: 
- 面试准备
- Vue
tag: Vue
---

## Vue生命周期

![vue生命周期](/images/vue/lifecycle.png)

在vue中，执行生命周期函数都是调用的callHook函数。
```js
function callHook (vm, hook) {
  // #7573 disable dep collection when invoking lifecycle hooks
  pushTarget();
  var handlers = vm.$options[hook];
  if (handlers) {
    for (var i = 0, j = handlers.length; i < j; i++) {
      try {
        handlers[i].call(vm);
      } catch (e) {
        handleError(e, vm, (hook + " hook"));
      }
    }
  }
  if (vm._hasHookEvent) {
    vm.$emit('hook:' + hook);
  }
  popTarget();
}
```
callHook的作用就是拿到实例上$options上的hook，也就是生命周期函数的数组。然后调用某个生命周期钩子注册所有的回调函数。

当实例化vue的时候，会先执行_init函数，beforeCreate和cteated生命周期就是在这里定义的。
```js
Vue.prototype._init = function (options?: Object) {
  // ...
  callHook(vm, 'beforeCreate')
  initInjections(vm) // resolve injections before data/props
  initState(vm)
  initProvide(vm) // resolve provide after data/props
  callHook(vm, 'created')
  // ...
}
```
我们可以看到initState函数是在beforeCreate后调用的，而initState函数是初始化props、data、methods、watch、computed等属性值的，所以，没有办法在beforeCreate中获取props、data、methods、watch、computed等属性值。而在created中可以获取到。

在这两个生命周期函数中并没有渲染DOM，所以我们不能够访问DOM。

我们还可以看到inject是在data、props之前初始化的，provide是在data、props之后初始化的。

beforeMount是在mountComponent函数中调用的。
```js
export function mountComponent (
  vm: Component,
  el: ?Element,
  hydrating?: boolean
): Component {
  vm.$el = el
  // ...
  callHook(vm, 'beforeMount')

  let updateComponent
  /* istanbul ignore if */
  if (process.env.NODE_ENV !== 'production' && config.performance && mark) {
    updateComponent = () => {
      const name = vm._name
      const id = vm._uid
      const startTag = `vue-perf-start:${id}`
      const endTag = `vue-perf-end:${id}`

      mark(startTag)
      const vnode = vm._render()
      mark(endTag)
      measure(`vue ${name} render`, startTag, endTag)

      mark(startTag)
      vm._update(vnode, hydrating)
      mark(endTag)
      measure(`vue ${name} patch`, startTag, endTag)
    }
  } else {
    updateComponent = () => {
      vm._update(vm._render(), hydrating)
    }
  }

  // we set this to vm._watcher inside the watcher's constructor
  // since the watcher's initial patch may call $forceUpdate (e.g. inside child
  // component's mounted hook), which relies on vm._watcher being already defined
  new Watcher(vm, updateComponent, noop, {
    before () {
      if (vm._isMounted) {
        callHook(vm, 'beforeUpdate')
      }
    }
  }, true /* isRenderWatcher */)
  hydrating = false

  // manually mounted instance, call mounted on self
  // mounted is called for render-created child components in its inserted hook
  if (vm.$vnode == null) {
    vm._isMounted = true
    callHook(vm, 'mounted')
  }
  return vm
}
```
我们可以看到在mountComponent中`vm.$el = el;`，将el挂载到了实例的$el上。然后执行beforeMount生命周期函数，但是这时候还是没有渲染DOM，我们看到这里使用了`callHook(vm, 'mounted');`，但是这里判断了一下vm.$vnode，如果是通过new vue的初始化过程就调用`callHook(vm, 'mounted');`，如果是组件的话，不是在这里调用的mounted生命周期函数。组件的mounted生命周期是在虚拟DOM patch到真实DOM上之后再调用的callHook来调用mounted生命周期。

beforeUpdate的执行时机也在mountComponent中。在mountComponent中有一个`new Watcher`在`new Watcher`里的before函数里执行的callHook。注意的是，这里判断了一下vm._isMounted，当组件已经mounted之后才会去调用beforeUpdate这个生命周期函数。

```js
 new Watcher(vm, updateComponent, noop, {
    before () {
      if (vm._isMounted) {
        callHook(vm, 'beforeUpdate')
      }
    }
  }, true /* isRenderWatcher */)
```

Watcher就是监听数据变化的函数，采用的是`发布订阅模式`和`数据劫持`结合的方法来实现。其中数据劫持在Vue2中使用的Object.defineProperty()的setter和getter属性，在Vue3中使用的`代理模式`，也就是`proxy`。

updated执行的时机就是当Wather监听到数据变化后，就会去遍历`谁订阅了这个数据`，当mounted存在时才会去调用callHook执行updated。

## 一般在哪个生命周期请求异步数据
我们可以在created、beforeMount、mounted中请求异步数据，因为在这三个生命周期中，data已经创建了，可以进行数据的赋值操作。
推荐在created中进行异步请求，created中请求的数据比beforeMount、mounted中的请求更快的获取到服务器的数据，用户体验更好。最重要的是SSR不支持beforeMount、mounted。

## vue父子组件执行顺序

### 创建和渲染阶段
```
父beforeCreate -> 父created -> 父beforeMount -> 
子boforeCreate -> 子created -> 子beforeMount -> 子mounted ->
父mounted
```

### 更新过程
```
父beforeUpdate ->
子beforeUpdate -> 子updated ->
父updated
```

### 销毁过程
```
父beforeDestroy ->
子beforeDestroy -> 子destroyed ->
父destroyed
```